<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How to port and run multi-node modules in cloud ci / gcp | Puppet IAC Team</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="How to port and run multi-node modules in cloud ci / gcp" />
<meta name="author" content="sheenaajay" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Multi Node Modules in GCP" />
<meta property="og:description" content="Multi Node Modules in GCP" />
<link rel="canonical" href="https://puppetlabs.github.io/iac/module/development/2021/05/07/running-multinode-modules-gcp.html" />
<meta property="og:url" content="https://puppetlabs.github.io/iac/module/development/2021/05/07/running-multinode-modules-gcp.html" />
<meta property="og:site_name" content="Puppet IAC Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-07T00:00:00+00:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://puppetlabs.github.io/iac/module/development/2021/05/07/running-multinode-modules-gcp.html"},"description":"Multi Node Modules in GCP","@type":"BlogPosting","url":"https://puppetlabs.github.io/iac/module/development/2021/05/07/running-multinode-modules-gcp.html","headline":"How to port and run multi-node modules in cloud ci / gcp","datePublished":"2021-05-07T00:00:00+00:00","dateModified":"2021-05-07T00:00:00+00:00","author":{"@type":"Person","name":"sheenaajay"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/iac/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://puppetlabs.github.io/iac/feed.xml" title="Puppet IAC Team" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-157301458-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/iac/">Puppet IAC Team</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/iac/docs/">Docs</a><a class="page-link" href="/iac/modules/">Modules</a><a class="page-link" href="/iac/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to port and run multi-node modules in cloud ci / gcp</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-05-07T00:00:00+00:00" itemprop="datePublished">May 7, 2021
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">sheenaajay</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="multi-node-modules-in-gcp">Multi Node Modules in GCP</h2>

<p><strong>Introduction</strong></p>

<p>Integration testing in puppet terms, is where we set up a number of vms/containers and test interactions between them. For example this may be</p>

<ul>
  <li>Install PE and set up some puppet agents to talk with it.</li>
  <li>Setup a NTP server, and register some ntp clients.</li>
  <li>Install puppet server and setup multiple puppet agents.</li>
</ul>

<p>Ordering of the tests is important, and being able to run a test on an individual system is paramount.</p>

<p><strong>Design</strong></p>

<p>We use the following workflow to run multi node modules on  Cloud CI / GCP.</p>

<ul>
  <li>Provision - We use provision task to provision a node for testing.</li>
  <li>Setup provisioned systems - We use bolt tasks/plans to setup the multi node environment for testing.</li>
  <li>Run tests - We use existing serverspec / litmus helpers to setup the dependencies and setup required for module
testing.</li>
  <li>Teardown -  We use provision task to teardown the machines.</li>
</ul>

<p>Lets go through each step in detail.</p>

<p><strong><em>Provision</em></strong></p>

<p>Litmus allows the provisioning of a vm/container via a task.
We use the provision module’s <a href="https://github.com/puppetlabs/provision/blob/main/tasks">available tasks</a> to spin up the test environment.
When run it creates an litmus_inventory.yaml file that allows both <a href="https://github.com/puppetlabs/bolt">bolt</a> and <a href="https://serverspec.org/">serverspec</a> to communicate with that vm/container.</p>

<p>How do we differentiate between different vm/containers? 
Provisioning tasks in the provision module allow us to add arbitrary key/pair values to the bolt inventory file. 
Using the bolt variables allows users to have multiple labels associated with a single machine.</p>

<p>By running the provision bolt tasks manually or through a bolt plan we can label machines.</p>

<p><img src="/iac/assets/2021-05-07-running-multinode-modules-gcp/inventory_role.png" alt="Showing role info in litmus_inventory.yaml file" /> 
<a href="https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/plans/provision_machines.pp">Example_websphere_provision_plan</a></p>

<p><strong><em>Setup provisioned systems</em></strong></p>

<p>Setup for litmus in acceptance tests relied on 3 things.</p>
<ul>
  <li>Install agent - A bolt <a href="https://github.com/puppetlabs/puppetlabs-puppet_agent/tree/main/tasks">task</a> that from a module which installs a puppet agent.</li>
  <li>Install module - A rake task that uses the pdk to build the module under test, and install that on the target vms/containers.</li>
  <li>spec/spec_helper_acceptance_local.rb - extra setup that may be required to test a module, Example <a href="https://github.com/puppetlabs/puppetlabs-apache/blob/main/spec/spec_helper_acceptance_local.rb">puppetlabs/puppetlabs-apache</a></li>
</ul>

<p>For integration testing we are using bolt plans and inventory variables where we can run puppet code / commands, against the specific systems, by labelling the systems.
An example <a href="https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/plans/pe_server_setup.pp">puppetlabs-websphere_application_server</a></p>

<p>Example for provision plan</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plan websphere_application_server::provision_machines(
  Optional[String] $using = 'abs',
  Optional[String] $image = 'centos-7-x86_64'
) {
  # provision machines, set roles
  ['server', 'appserver', 'dmgr', 'ihs'].each |$role| {
    run_task("provision::${using}", 'localhost', action =&gt; 'provision', platform =&gt; $image, vars =&gt; "role: ${role}")
  }
}
</code></pre></div></div>

<p>We can use spec/spec_helper_acceptance_local.rb for extra setup that may be required to test a module.
An example <a href="https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/spec/spec_helper_acceptance_local.rb">puppetlabs-websphere_application_server</a></p>

<p><strong><em>Run tests</em></strong></p>

<p>We use rspec labelling and rake task to identify the tests to run on integeration environment. Lets go through the details.</p>

<ul>
  <li>Rspec labelling
How do we differentiate acceptance tests from integration tests?
Using rspec labeling we can label tests, e.g. the test is tagged as integration. Everything else can stay the same.</li>
</ul>

<p>Example for tagging tests</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>describe 'Install the websphere dmgr', :integration do
  before(:all) do
    @agent = WebSphereHelper.dmgr_host
    WebSphereInstance.install(@agent)
    WebSphereDmgr.install(@agent)
  end

  it 'is installed' do
    expect(WebSphereHelper.remote_file_exists(@agent, WebSphereConstants.dmgr_status))
    expect(WebSphereHelper.remote_file_exists(@agent, WebSphereConstants.ws_admin))
  end
end
</code></pre></div></div>

<ul>
  <li>Integration test rake task
Adding a friendly rake task.This is added to the Rakefile of the module.</li>
</ul>

<p>Example for adding rake task</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'rspec/core/rake_task'
namespace :websphere_application_server do
  RSpec::Core::RakeTask.new(:integration) do |t|
    t.pattern = 'spec/acceptance/**{,/*/**}/*_spec.rb'
    t.rspec_opts = "--tag integration"
  end
end
</code></pre></div></div>

<ul>
  <li>
    <p>Helper functions to target labeled containers/vms
There are a number of helper methods required to allow tests to target a specific container/vm.
This is required for serverspec/litmus as it will be carrying out the tests on that container/vm.
Below are some examples or helper methods of filtering to get either a single vm/container or retrieving multiple vms/targets.</p>

    <p><a href="https://github.com/puppetlabs/puppetlabs-websphere_application_server/blob/main/spec/spec_helper_acceptance_local.rb">puppetlabs-websphere_application_server</a></p>

    <p><a href="https://github.com/puppetlabs/puppetlabs-kubernetes/blob/main/spec/spec_helper_acceptance_local.rb">puppetlabs-kubernetes</a></p>
  </li>
</ul>

<p>Example for identifying target nodes</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      context 'application deployment' do
        before(:all) { change_target_host('controller') }
        after(:all) { reset_target_host }
        it 'can deploy an application into a namespace and expose it' do
          run_shell('KUBECONFIG=/etc/kubernetes/admin.conf kubectl create -f /tmp/nginx.yml') do |r|
            expect(r.stdout).to match(/my-nginx created\nservice\/my-nginx created\n/)
          end
        end
</code></pre></div></div>

<ul>
  <li>
    <p>Testing
 The below command will only run tests labelled as ‘integration’</p>

    <p><code class="language-plaintext highlighter-rouge">bundle exec rake websphere_application_server:integration</code></p>
  </li>
</ul>

<p><strong><em>Teardown</em></strong></p>

<p>We use existing provision task to teardown all the provisioned machines.</p>

<p><code class="language-plaintext highlighter-rouge">bundle exec rake litmus:tear_down</code></p>

<h2 id="lets-go-through-different-scenarios-where-we-can-use-multi-node-testing">Lets go through different scenarios where we can use multi node testing</h2>

<p><strong><em>Multiple puppet agents</em></strong></p>

<p>In the setup we have many puppet agents, a module is installed and tests are run.</p>

<p>Commands</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run ntp::provision_gcp
bundle exec rake litmus:install_agent
bundle exec rake litmus:install_module
bundle exec rake ntp::integration
bundle exec rake 'litmus:tear_down'
</code></pre></div></div>
<p>Example
<a href="https://github.com/puppetlabs/puppetlabs-ntp/tree/multinodentp">puppetlabs-ntp</a></p>

<p><strong><em>Puppet server and agent</em></strong></p>

<p>In the setup we have puppet server and puppet agents, a module is installed and tests are run.
we can use bolt plans for provisioning number of nodes with roles tagged to each of it.
There is a new <a href="https://github.com/puppetlabs/provision/blob/main/tasks/install_puppetserver.json">task</a> to install open source puppet server in the provision module.</p>

<p>Commands</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run kubernetes::provision_cluster
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run kubernetes::puppetserver_setup
bundle exec rake litmus:install_agent
bundle exec rake litmus:install_module
bundle exec rake kubernetes::integration
bundle exec rake 'litmus:tear_down'
</code></pre></div></div>
<p>Example
<a href="https://github.com/puppetlabs/puppetlabs-kubernetes">puppetlabs-kubernetes</a></p>

<p><img src="/iac/assets/2021-05-07-running-multinode-modules-gcp/github_workflow.png" alt="Example github workflow run" /></p>

<p><strong><em>PE and agents</em></strong></p>

<p>In the setup we have PE server and puppet agents, a module is installed and tests are run.
we can use bolt plans for provisioning number of nodes with roles tagged to each of it.
There is a task to install PE in the puppet-deploy_pe module.
<a href="https://github.com/jarretlavallee/puppet-deploy_pe/tree/master/plans">provision_master/agents</a></p>

<p>Commands</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle install --path .bundle/gems/ --jobs 4
bundle exec rake spec_prep
bundle exec bolt --modulepath spec/fixtures/modules plan run ntp::provision_gcp
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run ntp::pe_server
bundle exec bolt --modulepath spec/fixtures/modules -i ./spec/fixtures/litmus_inventory.yaml plan run ntp::pe_agent
bundle exec rake litmus:install_module
bundle exec rake ntp::integration
bundle exec rake 'litmus:tear_down'
</code></pre></div></div>

<p>Example
<a href="https://github.com/puppetlabs/puppetlabs-ntp/tree/multinodentp">puppetlabs-ntp</a></p>

<p>Plan to install PE server</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plan ntp::pe_server(
  Optional[String] $version = '2019.8.5',
  Optional[Hash] $pe_settings = {password =&gt; 'puppetlabs'}
) {
  # identify pe server node
  $puppet_server =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpserver' }

  # install pe server
  run_plan(
    'deploy_pe::provision_master',
    $puppet_server,
    'version' =&gt; $version,
    'pe_settings' =&gt; $pe_settings
  )
}
</code></pre></div></div>

<p>Plan to install puppet agent</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plan ntp::pe_agent() {
  # identify pe server and agent nodes
  $puppet_server =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpserver' }
  $puppet_agent =  get_targets('*').filter |$n| { $n.vars['role'] == 'ntpclient' }

  # install agent
  run_plan(
    'deploy_pe::provision_agent',
    $puppet_agent,
    'master' =&gt; $puppet_server,
  )
}
</code></pre></div></div>

<h2 id="exampes-for-github-action-workflows-for-multi-node-modules">Exampes for GitHub Action Workflows for multi node modules</h2>

<ul>
  <li><a href="https://github.com/puppetlabs/puppetlabs-websphere_application_server/tree/main/.github/workflows">puppetlabs-websphere_application_server</a></li>
  <li><a href="https://github.com/puppetlabs/puppetlabs-kubernetes/tree/main/.github/workflows">puppetlabs-kubernetes</a></li>
</ul>

<h2 id="thank-you">Thank you</h2>

<p>Thanks <a href="https://github.com/tphoney">TP</a> for the valuable work on integration testing.
Thanks <a href="https://github.com/MartyEwings">Marty</a> for the work on installing PE on cloud CI.</p>

  </div><a class="u-url" href="/iac/module/development/2021/05/07/running-multinode-modules-gcp.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/iac/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Puppet IAC Team</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Puppet IAC Team</li><li><a class="u-email" href="mailto:ia_content@puppet.com">ia_content@puppet.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/puppetlabs"><svg class="svg-icon"><use xlink:href="/iac/assets/minima-social-icons.svg#github"></use></svg> <span class="username">puppetlabs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Team blog and list of maintained tools by and for the Puppet Infrastructure Automation Content Team.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
