<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Gem Testing with pdksync | Puppet IAC Team</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Gem Testing with pdksync" />
<meta name="author" content="sheenaajay" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="https://puppetlabs.github.io/iac/pdksync/testing/2020/02/12/gem-testing-with-pdksync.html" />
<meta property="og:url" content="https://puppetlabs.github.io/iac/pdksync/testing/2020/02/12/gem-testing-with-pdksync.html" />
<meta property="og:site_name" content="Puppet IAC Team" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-12T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"Introduction","headline":"Gem Testing with pdksync","dateModified":"2020-02-12T00:00:00+00:00","datePublished":"2020-02-12T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://puppetlabs.github.io/iac/pdksync/testing/2020/02/12/gem-testing-with-pdksync.html"},"url":"https://puppetlabs.github.io/iac/pdksync/testing/2020/02/12/gem-testing-with-pdksync.html","author":{"@type":"Person","name":"sheenaajay"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/iac/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://puppetlabs.github.io/iac/feed.xml" title="Puppet IAC Team" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-157301458-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/iac/">Puppet IAC Team</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/iac/docs/">Docs</a><a class="page-link" href="/iac/modules/">Modules</a><a class="page-link" href="/iac/tools/">Tools</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Gem Testing with pdksync</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-02-12T00:00:00+00:00" itemprop="datePublished">Feb 12, 2020
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">sheenaajay</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>

<p>pdksync enables you to do a lot more than just pdk update against a set of defined modules. In this blog post we will be going through single or multi gem testing features of pdksync.</p>

<h2 id="setup">Setup</h2>

<p>Download a fork of the repo, which can be found here <a href="https://github.com/puppetlabs/pdksync">pdksync</a>. Or you can install via Rubygems, it can be found here <a href="https://rubygems.org/gems/pdksync">pdksync</a>.
Install gems by using <code class="language-plaintext highlighter-rouge">bundle install</code>.
Ensure you have a GITHUB_TOKEN set in your env, if you don’t add it by running <code class="language-plaintext highlighter-rouge">export GITHUB_TOKEN=&lt;your github token&gt;</code>, this is required for authentication.
Important - Manually edit the list contained in ‘managed_modules.yml’ to ensure it is correct with the modules you wish to update. Please note this is critical as this tool will create PRs against the repos included in this list - you don’t want to run this against a module you aren’t familiar with. Do not proceed to the next step without doing this.
Run the rake task by using <code class="language-plaintext highlighter-rouge">bundle exec rake pdksync</code>.</p>

<h2 id="part-one-functionality-single-gem-testing">Part One: Functionality Single Gem Testing</h2>

<p>pdksync tool comes with the feature to update the Gemfile. Puppet provides a lot of useful gems to access and manage their functionality between modules. This functionality will help user to perform gem testing prior to release. User is given new rake tasks to update SHA/Version/Branch/line in the Gemfile. Then the changes can be committed, PR can be created which will run the acceptance tests in the PR. If all the tests are executing successfully then the user can close the PRS and release the gem.</p>

<blockquote>
  <h4 id="note">Note:</h4>

  <p>It assumes very limited familiarity with the <a href="https://github.com/puppetlabs/pdksync">pdksync</a> and <a href="https://puppet.com/blog/keep-your-puppet-modules-up-to-date-pdk/">pdk</a></p>

</blockquote>

<p>Run gem_file_update against modules</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:gem_file_update[:gem_to_test, :gem_line, :gem_sha_finder, :gem_sha_replacer, :gem_version_finder, :gem_version_replacer, :gem_branch_finder, :gem_branch_replacer]
</code></pre></div></div>
<p>eg rake to update gem line</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:gem_file_update[<span class="s1">'puppet_litmus'</span>, <span class="s2">"gem 'puppet_litmus'</span><span class="se">\,</span><span class="s2"> git: 'https://github.com/test/puppet_litmus.git'</span><span class="se">\,</span><span class="s2"> branch: 'testbranch'"</span><span class="o">]</span><span class="s1">'
</span></code></pre></div></div>
<p>eg rake to update sha</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:gem_file_update[<span class="s1">'puppet_litmus'</span>, <span class="s1">''</span>, <span class="s1">'20ee04ba1234e9e83eb2ffb5056e23d641c7a018'</span>, <span class="s1">'20ee04ba1234e9e83eb2ffb5056e23d641c7a31'</span><span class="o">]</span>
</code></pre></div></div>
<p>eg rake to update version</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:gem_file_update[<span class="s1">'puppet_litmus'</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s2">"= 0.9.0"</span>, <span class="s2">"&lt;= 0.10.0"</span>, <span class="s1">''</span>, <span class="s1">''</span><span class="o">]</span>
</code></pre></div></div>
<p>eg rake to update branch</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:gem_file_update[<span class="s1">'puppet_litmus'</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s1">''</span>, <span class="s1">'testbranch'</span>, <span class="s1">'testbranches'</span><span class="o">]</span>
</code></pre></div></div>

<p>Below given are the workflows for doing single gem testing with pdksync.</p>

<p>In Workflow 1 we can clone modules, update the gem file, create the commit, push the changes and create the PR using separate rake tasks.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install</span> <span class="nt">--path</span> .bundle/gems/
bundle <span class="nb">exec </span>rake git:clone_managed_modules
bundle <span class="nb">exec </span>rake <span class="s1">'pdksync:gem_file_update[]'</span>
bundle <span class="nb">exec </span>rake <span class="s1">'git:create_commit[]'</span>
bundle <span class="nb">exec </span>rake <span class="s1">'git:push'</span>
bundle <span class="nb">exec </span>rake <span class="s1">'git:create_pr[]'</span>
</code></pre></div></div>

<p>In Workflow 2 we can clone modules, update the gem file, create the commit, push the changes and create the PR using single rake task</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using single rake job
bundle install --path .bundle/gems/
bundle exec rake 'gem_testing[]'
</code></pre></div></div>

<p>Once the verified gem is released we can use pdksync to update the the new version of gem released in the <code class="language-plaintext highlighter-rouge">.sync.yaml</code> file.</p>

<h2 id="part-two-functionality-multi-gem-testing">Part Two: Functionality Multi Gem Testing</h2>

<p>pdksync tool is extended with the feature to perform multi gem testing (<code class="language-plaintext highlighter-rouge">puppet-module-gems</code>). This functionality will identify the current version and bump the version by one. Then it will build and push the gems to gemfury account. Export the GEMFURY_TOKEN to use this rake task.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">GEMFURY_TOKEN</span><span class="o">=</span>&lt;access_token&gt;
</code></pre></div></div>

<p>Run the following commands to check that everything is working as expected:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install</span> <span class="nt">--path</span> .bundle/gems/
bundle <span class="nb">exec </span>rake <span class="nt">-T</span>
bundle <span class="nb">exec </span>rake <span class="s1">'git:clone_gem[puppet-module-gems]'</span>
</code></pre></div></div>

<p>Run multigem_file_update against modules:</p>

<p>Clone gem</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git:clone_gem[<span class="s1">'puppet-module-gems'</span><span class="o">]</span>
</code></pre></div></div>

<p>Build and Push new gems built to the gemfury account for testing</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:multi_gem_testing[<span class="s1">'puppet-module-gems'</span>,<span class="s1">'config/info.yml'</span>,<span class="s1">'exe/build-gems.rb'</span>,<span class="s1">'pkg'</span>,<span class="s1">'gem_tester'</span><span class="o">]</span>
</code></pre></div></div>

<p>Update Gemfile of the modules with the new gem should be pushed to Gemfury.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdksync:multigem_file_update[<span class="s1">'puppet-module'</span>,<span class="s1">'tester'</span><span class="o">]</span>
</code></pre></div></div>

<p>Below given is the workflows for doing multi gem testing with pdksync.</p>

<p>In this workflow we can clone gems, update the version, build the gem, push the changes to gemfury and update the gem file of the required modules with the latest gem updated in the fury. Then we can create PR or run tests locally or run tests through jenkins to verify the module test results.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bundle <span class="nb">install</span> <span class="nt">--path</span> .bundle/gems/
bundle <span class="nb">exec </span>rake <span class="s1">'git:clone_gem[puppet-module-gems]'</span>
bundle <span class="nb">exec </span>rake <span class="s1">'pdksync:multi_gem_testing[]'</span>
bundle <span class="nb">exec </span>rake <span class="s1">'pdksync:multigem_file_update[]'</span>
</code></pre></div></div>

<h2 id="wrapping-up">Wrapping Up</h2>

<p>These are the steps that we can follow to perform single or multi gem testing using pdksync.</p>

  </div><a class="u-url" href="/iac/pdksync/testing/2020/02/12/gem-testing-with-pdksync.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/iac/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Puppet IAC Team</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Puppet IAC Team</li><li><a class="u-email" href="mailto:ia_content@puppet.com">ia_content@puppet.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/puppetlabs"><svg class="svg-icon"><use xlink:href="/iac/assets/minima-social-icons.svg#github"></use></svg> <span class="username">puppetlabs</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Team blog and list of maintained tools by and for the Puppet Infrastructure Automation Content Team.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
